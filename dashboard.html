<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>KognAktif | Dashboard</title>
  <link rel="icon" type="image/png" href="images/favicon.png">
  <link rel="stylesheet" href="css/dashboard.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
  
  <!-- Navbar -->
  <nav class="navbar">
    <div class="logo">
        <img src="images/Kog_logowhite.png" alt="KognAktif Logo">
    </div>
    <ul class="nav-links">
      <li><a href="#" class="active">Dashboard</a></li>
      <li><a href="dashgames.html">Games</a></li>
      <li><a href="dashanalytics.html">Analytic</a></li>
      <li><a href="dashsetting.html">Setting</a></li>
    </ul>
    <div class="nav-right">
      <button class="notif-btn">ðŸ””</button>
      <div class="user-menu">
        <div class="user-name" id="userName">Loading...</div>
        <div class="dropdown" id="dropdownMenu">
          <button id="logout-btn">Logout</button>
        </div>   
      </div> 
    </div>
  </nav>

  <!-- Main Dashboard Content -->
  <main class="dashboard">
    <div class="profile-card">
      <div class="avatar"></div>
      <div class="welcome">
        <h2>Hi <span id="welcomeName">User</span>!</h2>
        <p>Welcome to <strong>KognAktif</strong>! Hope you're having a great day.</p>
      </div>
    </div>

    <!-- Dashboard Cards Container -->
    <div class="dashboard-cards">
      <!-- Child Information Card -->
      <div class="profile-card child-info-card">
        <h3>Your Child Information</h3> 
        <div class="child-details">
          <div class="info-item">
            <label>Name:</label>
            <span id="childName">-</span>
          </div>
          <div class="info-item">
            <label>Age:</label>
            <span id="childAge">-</span>
          </div>
          <div class="info-item">
            <label>Gender:</label>
            <span id="childGender">-</span>
          </div>
          <div class="info-item">
            <label>Health Category:</label>
            <span id="childHealthCategory">-</span>
          </div>
        </div>
      </div>

      <!-- Last Session Card -->
      <div class="profile-card session-card">
        <h3>Last Session Dated</h3>
        <div class="session-details">
          <div class="info-item">
        <img src="images/date.png" alt="Date icon" class="info-icon">
        <label>Date:</label>
        <span id="lastSessionDate">-</span>
          </div>
          <div class="info-item">
        <img src="images/time2.png" alt="Time icon" class="info-icon">
        <label>Time:</label>
        <span id="lastSessionTime">-</span>
          </div>
          <div class="info-item">
        <img src="images/module2.png" alt="Module icon" class="info-icon">
        <label>Module:</label>
        <span id="lastSessionGameModule">-</span>
          </div>
        </div>
      </div>

      <!-- Status Card -->
      <div class="profile-card status-card">
        <h3>Status</h3>
        <div class="status-details">
          <div class="info-item">
            <label>Activity Level:</label>
            <span id="activityLevel">-</span>
          </div>
          <div class="info-item">
            <label>Progress:</label>
            <span id="progressStatus">-</span>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <section id="footer" class="footer-section">
    <div class="footer-text">Â© 2025 kognaktif.com â€” All Rights Reserved</div>
    <div class="footer-links">
      <a href="#">Terms of Service</a>
      <a href="#">Privacy Policy</a>
    </div>
  </section>


  <!-- Supabase Auth Script -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const supabase = window.supabase.createClient(
  "https://ijugaqvsszticpzrznnb.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlqdWdhcXZzc3p0aWNwenJ6bm5iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2MjIwMjksImV4cCI6MjA3MzE5ODAyOX0.kx29Dr1eAIKdeRwpH9VBYerKuHYWz2wIvNYc85ms5mY"
  );

async function checkAuth() {
  const { data: { session } } = await supabase.auth.getSession();

  if (!session) {
    window.location.href = "index.html";
    return;
  }

  const user = session.user;
  const userEmail = user.email;

  // Fetch user profile
  const { data: profile, error } = await supabase
    .from('profiles')
    .select('firstname, cfirstname, clastname, birthday, healthcategory, cgender')
    .eq('id', user.id)
    .maybeSingle();  // prevents crash if no row

  // Determine display name
  let displayName = userEmail; // fallback
  if (profile && profile.firstname && profile.firstname.trim() !== "") {
    displayName = profile.firstname;
  }

  document.getElementById("userName").textContent = displayName;
  document.getElementById("welcomeName").textContent = displayName;

  // Update child information (safe)
  if (profile) {
    const childFullName = `${profile.cfirstname || ''} ${profile.clastname || ''}`.trim();
    document.getElementById("childName").textContent = childFullName || 'Not available';

    if (profile.birthday) {
      const birthDate = new Date(profile.birthday);
      const age = Math.floor((new Date() - birthDate) / (365.25 * 24 * 60 * 60 * 1000));
      document.getElementById("childAge").textContent = age + ' years old';
    } else {
      document.getElementById("childAge").textContent = 'Not available';
    }

    document.getElementById("childGender").textContent = profile.cgender || 'Not available';
    document.getElementById("childHealthCategory").textContent = profile.healthcategory || 'Not available';
  } else {
    document.getElementById("childName").textContent = 'Not available';
    document.getElementById("childAge").textContent = 'Not available';
    document.getElementById("childGender").textContent = 'Not available';
    document.getElementById("childHealthCategory").textContent = 'Not available';
  }

  // Fetch game results
  await fetchLastSession(userEmail);
}

async function fetchLastSession(userEmail) {
  const { data: buzzTap } = await supabase
    .from('buzztap_results')
    .select('created_at')
    .eq("player_email", userEmail)
    .order('created_at', { ascending: false })
    .limit(1)
    .maybeSingle();

  const { data: shapeSense } = await supabase
    .from('shapesense_results')
    .select('created_at')
    .eq("player_email", userEmail)
    .order('created_at', { ascending: false })
    .limit(1)
    .maybeSingle();

  const { data: orbCatcher } = await supabase
    .from('orbcatcher_results')
    .select('created_at')
    .eq("player_email", userEmail)
    .order('created_at', { ascending: false })
    .limit(1)
    .maybeSingle();

  // Determine last played
  let lastSession = null;
  let gameModule = '';

  const sessions = [];
  if (buzzTap) sessions.push({ date: new Date(buzzTap.created_at), name: 'Buzz Tap!' });
  if (shapeSense) sessions.push({ date: new Date(shapeSense.created_at), name: 'Shape Sense' });
  if (orbCatcher) sessions.push({ date: new Date(orbCatcher.created_at), name: 'Orb Catcher' });

  if (sessions.length > 0) {
    sessions.sort((a, b) => b.date - a.date);
    lastSession = sessions[0].date;
    gameModule = sessions[0].name;
  }

  // Update UI
  if (lastSession) {
    document.getElementById("lastSessionDate").textContent =
      lastSession.toLocaleDateString('en-GB');
    document.getElementById("lastSessionTime").textContent =
      lastSession.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: true });
    document.getElementById("lastSessionGameModule").textContent = gameModule;
  } else {
    document.getElementById("lastSessionDate").textContent = 'No session yet';
    document.getElementById("lastSessionTime").textContent = '-';
    document.getElementById("lastSessionGameModule").textContent = '-';
  }
}

checkAuth();

// Logout
async function logout() {
  await supabase.auth.signOut();
  window.location.href = "index.html";
}

document.getElementById("logout-btn").addEventListener("click", logout);

// User menu dropdown
const userMenu = document.querySelector(".user-menu");
const userName = document.getElementById("userName");

userName.addEventListener("click", () => {
  userMenu.classList.toggle("active");
});

document.addEventListener("click", (e) => {
  if (!userMenu.contains(e.target) && e.target !== userName) {
    userMenu.classList.remove("active");
  }
});


</script>

</body>
</html>